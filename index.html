<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DS Textile Lab | Pro Background Remover</title>
<style>
  :root{--bg:#0b1220;--card:#0f1b34;--muted:#a9b7d0;--txt:#e9f0ff;--line:#233457;--btn:#2b5cff}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:radial-gradient(1200px 600px at 20% 0%,#14264a 0%,#0b1220 50%,#070b14 100%);color:var(--txt)}
  header{padding:18px 14px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:rgba(11,18,32,.8);backdrop-filter:blur(10px);z-index:10}
  header h1{margin:0;font-size:18px;letter-spacing:.2px}
  header p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(15,27,52,.86),rgba(10,16,32,.86));border:1px solid rgba(255,255,255,.08);
        border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
  .title{font-size:14px;margin:0 0 8px;color:#d9e6ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:0;background:var(--btn);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;
       font-weight:600;font-size:13px}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .btn.secondary{background:#1b2a4a}
  .hint{color:var(--muted);font-size:12px;line-height:1.4;margin-top:8px}
  .control{padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.16)}
  label{display:block;font-size:12px;color:#cfe0ff;margin-bottom:6px}
  input[type="range"]{width:100%}
  select, input[type="file"]{width:100%;color:var(--txt);background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.1);
    padding:10px;border-radius:12px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);
        background:rgba(0,0,0,.18);color:#d8e6ff;font-size:12px}
  .preview{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:700px){.preview{grid-template-columns:1fr}}
  .pane{border:1px solid rgba(255,255,255,.1);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.18)}
  .paneHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .paneHead strong{font-size:13px}
  .paneHead span{font-size:12px;color:var(--muted)}
  canvas{width:100%;height:auto;display:block;cursor:crosshair;touch-action:none}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;background:rgba(255,255,255,.1);
       padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.12)}
  .footer{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.5}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>DS Textile Lab — Pro Background Remover</h1>
    <p>Textile motifs & embroidery assets • Clean PNG export • Improved matte + edge tighten + auto-contrast</p>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Left controls -->
    <div class="card">
      <p class="title">1) Upload</p>
      <input id="file" type="file" accept="image/*" />

      <div style="height:10px"></div>

      <p class="title">2) Mode</p>
      <div class="control">
        <label for="mode">Background type</label>
        <select id="mode">
          <option value="solid" selected>Solid / White / Cream BG (Textile Motif)</option>
          <option value="light">Studio Light BG (Near-white gradients)</option>
        </select>
        <div class="hint">Solid = motifs के लिए best. Light = photo-like background.</div>
      </div>

      <div style="height:10px"></div>

      <p class="title">3) Precision</p>
      <div class="control">
        <label>Cut Strength (Tolerance): <span id="tolVal" class="pill">35</span></label>
        <input id="tol" type="range" min="5" max="120" value="35" />
        <div class="hint">Motif के लिए 28–40 से start करें.</div>
      </div>

      <div style="height:10px"></div>

      <div class="control">
        <label>Edge Feather (Softness): <span id="featherVal" class="pill">2</span></label>
        <input id="feather" type="range" min="0" max="10" value="2" />
        <div class="hint">1–3 recommended.</div>
      </div>

      <div style="height:10px"></div>

      <div class="control">
        <label>Edge Tighten (Crisp): <span id="tightVal" class="pill">1</span></label>
        <input id="tight" type="range" min="0" max="4" value="1" />
        <div class="hint">Outline/halo कम करने के लिए. 1–2 recommended.</div>
      </div>

      <div style="height:10px"></div>

      <div class="control">
        <label>Auto-Contrast (Pre-Clean): <span id="acVal" class="pill">12</span></label>
        <input id="autocontrast" type="range" min="0" max="25" value="12" />
        <div class="hint">Background को uniform बनाता है (quality boost). 8–15 best.</div>
      </div>

      <div style="height:10px"></div>

      <div class="control">
        <label>Despeckle (Dust Remove): <span id="despVal" class="pill">1</span></label>
        <input id="desp" type="range" min="0" max="3" value="1" />
        <div class="hint">Tiny dots हटाने के लिए 1–2.</div>
      </div>

      <div style="height:10px"></div>

      <p class="title">4) Smart Sampling</p>
      <div class="control">
        <div class="row" style="justify-content:space-between">
          <span class="pill">Auto BG corners+edges</span>
          <span class="pill">Manual picker: <span class="kbd">Click Original</span></span>
        </div>
        <div class="hint">Auto गलत हो तो Original canvas के background पर click करें.</div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button id="run" class="btn" disabled>Remove Background</button>
        <button id="reset" class="btn secondary" disabled>Reset</button>
        <button id="download" class="btn" disabled>Download PNG</button>
      </div>

      <div class="footer">
        Best: Tolerance 30–35, Feather 1–2, Tighten 1–2, Auto-Contrast 10–15
      </div>
    </div>

    <!-- Right previews -->
    <div class="card">
      <div class="preview">
        <div class="pane">
          <div class="paneHead">
            <strong>Original</strong>
            <span id="origInfo">—</span>
          </div>
          <canvas id="c1"></canvas>
        </div>
        <div class="pane">
          <div class="paneHead">
            <strong>Cutout (Transparent)</strong>
            <span id="outInfo">—</span>
          </div>
          <canvas id="c2"></canvas>
        </div>
      </div>
      <div class="hint" style="margin-top:10px">
        Manual BG pick = Original पर click (embed में भी).
      </div>
    </div>
  </div>
</div>

<script>
const file = document.getElementById('file');
const runBtn = document.getElementById('run');
const resetBtn = document.getElementById('reset');
const dlBtn = document.getElementById('download');

const tol = document.getElementById('tol');
const feather = document.getElementById('feather');
const tight = document.getElementById('tight');
const autocontrast = document.getElementById('autocontrast');
const desp = document.getElementById('desp');
const mode = document.getElementById('mode');

const tolVal = document.getElementById('tolVal');
const featherVal = document.getElementById('featherVal');
const tightVal = document.getElementById('tightVal');
const acVal = document.getElementById('acVal');
const despVal = document.getElementById('despVal');

const c1 = document.getElementById('c1');
const c2 = document.getElementById('c2');
const ctx1 = c1.getContext('2d', {willReadFrequently:true});
const ctx2 = c2.getContext('2d', {willReadFrequently:true});

const origInfo = document.getElementById('origInfo');
const outInfo = document.getElementById('outInfo');

let img = new Image();
let originalData = null;
let pickedBG = null;
let hasImage = false;

tol.addEventListener('input',()=> tolVal.textContent = tol.value);
feather.addEventListener('input',()=> featherVal.textContent = feather.value);
tight.addEventListener('input',()=> tightVal.textContent = tight.value);
autocontrast.addEventListener('input',()=> acVal.textContent = autocontrast.value);
desp.addEventListener('input',()=> despVal.textContent = desp.value);

// Utils
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function distRGB(r,g,b, r2,g2,b2){
  const dr=r-r2, dg=g-g2, db=b-b2;
  return Math.sqrt(dr*dr + dg*dg + db*db);
}

// Auto background pick
function autoPickBG(data, w, h){
  const samples = [];
  const pick = (x,y)=>{
    const i = (y*w + x)*4;
    samples.push([data[i],data[i+1],data[i+2]]);
  };

  const pad = Math.max(2, Math.floor(Math.min(w,h)*0.012));
  for(let dy=0; dy<pad; dy++){
    for(let dx=0; dx<pad; dx++){
      pick(dx,dy); pick(w-1-dx,dy); pick(dx,h-1-dy); pick(w-1-dx,h-1-dy);
    }
  }

  const step = Math.max(12, Math.floor(Math.min(w,h)/55));
  for(let x=0; x<w; x+=step){ pick(x,pad); pick(x,h-1-pad); }
  for(let y=0; y<h; y+=step){ pick(pad,y); pick(w-1-pad,y); }

  samples.sort((a,b)=>(a[0]+a[1]+a[2])-(b[0]+b[1]+b[2]));
  const trim = Math.floor(samples.length*0.12);
  const core = samples.slice(trim, samples.length-trim);

  let r=0,g=0,b=0;
  for(const s of core){ r+=s[0]; g+=s[1]; b+=s[2]; }
  return [Math.round(r/core.length), Math.round(g/core.length), Math.round(b/core.length)];
}

// Auto-contrast pre-clean (very light, quality-only)
// strength: 0..25. We expand luma range slightly to make BG more uniform.
function applyAutoContrast(imgData, w, h, strength){
  if(strength<=0) return imgData;
  const d = imgData.data;

  // sample luma quickly (not every pixel for speed)
  let minL=255, maxL=0;
  const step = Math.max(1, Math.floor((w*h)/180000)); // adaptive sampling
  for(let i=0; i<d.length; i+=4*step){
    const r=d[i], g=d[i+1], b=d[i+2];
    const l = (0.2126*r + 0.7152*g + 0.0722*b);
    if(l<minL) minL=l;
    if(l>maxL) maxL=l;
  }

  // prevent overboost
  const range = Math.max(12, maxL - minL);
  const targetBoost = strength / 25; // 0..1
  const lo = minL + range * 0.10 * targetBoost;
  const hi = maxL - range * 0.10 * targetBoost;
  const denom = Math.max(1, hi - lo);

  for(let i=0; i<d.length; i+=4){
    let r=d[i], g=d[i+1], b=d[i+2];
    r = clamp(((r - lo) * 255) / denom, 0, 255);
    g = clamp(((g - lo) * 255) / denom, 0, 255);
    b = clamp(((b - lo) * 255) / denom, 0, 255);
    d[i]=r; d[i+1]=g; d[i+2]=b;
  }
  return imgData;
}

// Feather alpha
function featherAlpha(imgData, w, h, radius){
  if(radius<=0) return imgData;
  const d = imgData.data;
  const a = new Uint8ClampedArray(w*h);
  for(let i=0,p=0;i<d.length;i+=4,p++) a[p]=d[i+3];

  const outA = new Uint8ClampedArray(w*h);
  const r = radius;

  for(let y=0; y<h; y++){
    for(let x=0; x<w; x++){
      let sum=0,cnt=0;
      for(let yy=y-r; yy<=y+r; yy++){
        if(yy<0||yy>=h) continue;
        for(let xx=x-r; xx<=x+r; xx++){
          if(xx<0||xx>=w) continue;
          sum+=a[yy*w+xx]; cnt++;
        }
      }
      outA[y*w+x]=Math.round(sum/cnt);
    }
  }
  for(let i=0,p=0;i<d.length;i+=4,p++) d[i+3]=outA[p];
  return imgData;
}

// Despeckle alpha
function despeckle(imgData, w, h, level){
  if(level<=0) return imgData;
  const d = imgData.data;

  const pass = (mode)=>{
    const a = new Uint8ClampedArray(w*h);
    for(let i=0,p=0;i<d.length;i+=4,p++) a[p]=d[i+3];
    const out = new Uint8ClampedArray(a);

    const thr = mode===0 ? 30 : 235;
    const r = 1 + (level-1);

    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        const idx=y*w+x;
        const center=a[idx];
        let neigh=0,total=0;

        for(let yy=y-r;yy<=y+r;yy++){
          if(yy<0||yy>=h) continue;
          for(let xx=x-r;xx<=x+r;xx++){
            if(xx<0||xx>=w) continue;
            total++;
            const v=a[yy*w+xx];
            if(v>thr) neigh++;
          }
        }
        if(mode===0 && center>thr && neigh<=Math.max(2,Math.floor(total*0.14))) out[idx]=0;
        if(mode===1 && center<thr && neigh>=Math.floor(total*0.76)) out[idx]=255;
      }
    }
    for(let i=0,p=0;i<d.length;i+=4,p++) d[i+3]=out[p];
  };

  pass(0); pass(1);
  return imgData;
}

// Upload
file.addEventListener('change',(e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    img=new Image();
    img.onload=()=>{
      c1.width=img.naturalWidth; c1.height=img.naturalHeight;
      c2.width=img.naturalWidth; c2.height=img.naturalHeight;
      ctx1.clearRect(0,0,c1.width,c1.height);
      ctx2.clearRect(0,0,c2.width,c2.height);
      ctx1.drawImage(img,0,0);
      originalData=ctx1.getImageData(0,0,c1.width,c1.height);
      hasImage=true; pickedBG=null;
      origInfo.textContent=`${img.naturalWidth}×${img.naturalHeight}px`;
      outInfo.textContent='—';
      runBtn.disabled=false; resetBtn.disabled=false; dlBtn.disabled=true;
    };
    img.src=reader.result;
  };
  reader.readAsDataURL(f);
});

// Manual BG picker (embed-friendly)
c1.addEventListener('pointerdown',(ev)=>{
  if(!hasImage) return;
  const rect=c1.getBoundingClientRect();
  const x=Math.round((ev.clientX-rect.left)*(c1.width/rect.width));
  const y=Math.round((ev.clientY-rect.top)*(c1.height/rect.height));
  const px=ctx1.getImageData(x,y,1,1).data;
  pickedBG=[px[0],px[1],px[2]];
  outInfo.textContent=`BG picked: rgb(${pickedBG.join(',')})`;
});

// Reset
resetBtn.addEventListener('click',()=>{
  if(!hasImage) return;
  ctx1.putImageData(originalData,0,0);
  ctx2.clearRect(0,0,c2.width,c2.height);
  pickedBG=null; outInfo.textContent='—'; dlBtn.disabled=true;
});

// Download
dlBtn.addEventListener('click',()=>{
  if(!hasImage) return;
  const a=document.createElement('a');
  a.download='ds-textile-cutout.png';
  a.href=c2.toDataURL('image/png');
  a.click();
});

// Main removal
runBtn.addEventListener('click',()=>{
  if(!hasImage) return;

  ctx1.putImageData(originalData,0,0);
  let base=ctx1.getImageData(0,0,c1.width,c1.height);
  const w=c1.width, h=c1.height;

  // NEW: Auto-contrast pre-clean (quality boost)
  base = applyAutoContrast(base, w, h, parseInt(autocontrast.value,10));

  const d=base.data;
  const bg = pickedBG ?? autoPickBG(d,w,h);
  const T = parseInt(tol.value,10);
  const md = mode.value;
  const edgeT = parseInt(tight.value,10);
  const edgeSubtract = edgeT * 18;

  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];

    let score=0;
    if(md==="solid"){
      score=distRGB(r,g,b,bg[0],bg[1],bg[2]);
    }else{
      const br=(r*0.2126+g*0.7152+b*0.0722);
      const bb=(bg[0]*0.2126+bg[1]*0.7152+bg[2]*0.0722);
      const colorDist=distRGB(r,g,b,bg[0],bg[1],bg[2]);
      const brightDist=Math.abs(br-bb);
      score=(0.55*colorDist+0.80*brightDist);
    }

    let alpha=255;
    if(score<T) alpha=0;
    else if(score<T+28) alpha=Math.round(((score-T)/28)*255);

    if(alpha<255) alpha=Math.max(0, alpha-edgeSubtract);

    d[i+3]=alpha;

    // halo fix
    if(alpha<235){
      const f=alpha/255;
      d[i]=Math.round(r*f);
      d[i+1]=Math.round(g*f);
      d[i+2]=Math.round(b*f);
    }
  }

  let out=base;
  out=featherAlpha(out,w,h,parseInt(feather.value,10));
  out=despeckle(out,w,h,parseInt(desp.value,10));

  ctx2.putImageData(out,0,0);
  outInfo.textContent=`Ready • BG rgb(${bg.join(',')}) • tol ${T} • tighten ${edgeT} • AC ${autocontrast.value}`;
  dlBtn.disabled=false;
});
</script>
</body>
</html>
